name: Build and Push Docker Image to Harbor

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate Incremental Tag
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          NEW_TAG="1.$RUN_NUMBER"
          echo "New Tag: $NEW_TAG"
          echo "IMAGE_TAG=192.168.2.184/momo/front:$NEW_TAG" >> $GITHUB_ENV

      - name: Debug IMAGE_TAG
        run: |
          echo "IMAGE_TAG is set to: $IMAGE_TAG"

      - name: Build and Push Docker Image to Harbor
        env:
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin 192.168.2.184
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

  vulnerability-scan:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Get Latest Image Tag from Harbor
        env:
          HARBOR_URL: "192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          IMAGE_NAME: "momo/front"
        run: |
          LATEST_TAG=$(curl -s -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" "http://$HARBOR_URL/api/v2.0/projects/momo/repositories/front/artifacts" | jq -r '.[0].tags[0].name')
          
          if [[ -z "$LATEST_TAG" ]]; then
            echo "ERROR: Could not retrieve latest image tag!"
            exit 1
          fi
          
          echo "Latest Image Tag: $LATEST_TAG"
          echo "IMAGE_TAG=$LATEST_TAG" >> $GITHUB_ENV

      - name: Trigger Harbor Vulnerability Scan
        env:
          HARBOR_URL: "192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          IMAGE_NAME: "momo/front"
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          curl -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" -X POST "http://$HARBOR_URL/api/v2.0/projects/momo/repositories/front/artifacts/$IMAGE_TAG/scan"
          echo "Triggered scan for image: $IMAGE_TAG"

      - name: Wait for Scan to Complete (Polling)
        env:
          HARBOR_URL: "192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          IMAGE_NAME: "momo/front"
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo "Waiting for scan results..."
          for i in {1..30}; do
            SCAN_STATUS=$(curl -s -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" "http://$HARBOR_URL/api/v2.0/projects/momo/repositories/front/artifacts/$IMAGE_TAG" | jq -r '.scan_overview["application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0"].scan_status')
            echo "Current scan status: $SCAN_STATUS"
            
            if [[ "$SCAN_STATUS" == "Success" ]]; then
              echo "Scan completed successfully!"
              break
            elif [[ "$SCAN_STATUS" == "Error" ]]; then
              echo "Scan failed!"
              exit 1
            fi
            
            sleep 10
          done

      - name: Get Harbor Scan Results
        env:
          HARBOR_URL: "192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
          IMAGE_NAME: "momo/front"
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          RESULT=$(curl -s -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" "http://$HARBOR_URL/api/v2.0/projects/momo/repositories/front/artifacts/$IMAGE_TAG?vulnerabilities=true")
          
          CRITICAL_COUNT=$(echo "$RESULT" | jq '.scan_overview["application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0"].summary.Critical // 0')
          HIGH_COUNT=$(echo "$RESULT" | jq '.scan_overview["application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0"].summary.High // 0')

          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"

          echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_ENV
          echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_ENV

      - name: Send Scan Report to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          HARBOR_URL: "192.168.2.184"
          IMAGE_NAME: "momo/front"
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          MESSAGE="{
            \"attachments\": [
              {
                \"color\": \"#ff0000\",
                \"title\": \"üîç Harbor Image Security Scan Report\",
                \"fields\": [
                  {\"title\": \"üõë Critical\", \"value\": \"$CRITICAL_COUNT\", \"short\": true},
                  {\"title\": \"‚ö†Ô∏è High\", \"value\": \"$HIGH_COUNT\", \"short\": true}
                ],
                \"footer\": \"Harbor Trivy Scanner\",
                \"ts\": $(date +%s)
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL

