name: Harbor Webhook Triggered Security Scan

on:
  repository_dispatch:
    types: [harbor-webhook]

jobs:
  process-harbor-webhook:
    runs-on: self-hosted

    steps:
      - name: Extract Harbor Webhook Data
        run: |
          echo "Extracting data from Harbor Webhook payload..."
          cat $GITHUB_EVENT_PATH | jq '.'
          
          IMAGE_NAME=$(cat $GITHUB_EVENT_PATH | jq -r '.event_data.resources[0].repository')
          IMAGE_TAG=$(cat $GITHUB_EVENT_PATH | jq -r '.event_data.resources[0].tag')
          
          if [[ -z "$IMAGE_NAME" || -z "$IMAGE_TAG" ]]; then
            echo "ERROR: Could not extract image name or tag from Harbor Webhook"
            exit 1
          fi

          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Trigger Harbor Vulnerability Scan
        env:
          HARBOR_URL: "https://192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Triggering scan for $IMAGE_NAME:$IMAGE_TAG..."
          curl -k -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" -X POST "$HARBOR_URL/api/v2.0/projects/momo/repositories/$IMAGE_NAME/artifacts/$IMAGE_TAG/scan"

      - name: Get Harbor Scan Results
        env:
          HARBOR_URL: "https://192.168.2.184"
          HARBOR_USERNAME: "admin"
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Fetching vulnerability scan results..."
          RESULT=$(curl -k -s -u "$HARBOR_USERNAME:$HARBOR_PASSWORD" "$HARBOR_URL/api/v2.0/projects/momo/repositories/$IMAGE_NAME/artifacts/$IMAGE_TAG?vulnerabilities=true")
          
          CRITICAL_COUNT=$(echo "$RESULT" | jq '[.[] | .scan_overview["application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0"].summary.Critical // 0] | add')
          HIGH_COUNT=$(echo "$RESULT" | jq '[.[] | .scan_overview["application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0"].summary.High // 0] | add')

          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"

          echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_ENV
          echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_ENV

      - name: Send Scan Report to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MESSAGE="{
            \"attachments\": [
              {
                \"color\": \"#ff0000\",
                \"title\": \"üîç Harbor Image Security Scan Report\",
                \"fields\": [
                  {\"title\": \"üì¶ Image\", \"value\": \"\`$IMAGE_NAME:$IMAGE_TAG\`\", \"short\": false},
                  {\"title\": \"üõë Critical\", \"value\": \"$CRITICAL_COUNT\", \"short\": true},
                  {\"title\": \"‚ö†Ô∏è High\", \"value\": \"$HIGH_COUNT\", \"short\": true}
                ],
                \"footer\": \"Harbor Trivy Scanner\",
                \"ts\": $(date +%s)
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL

