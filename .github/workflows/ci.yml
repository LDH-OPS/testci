name: Build and Push Docker Image to Harbor

on:
  push:
    branches:
      - main  # main 브랜치에 푸시될 때 실행

jobs:
  build-and-push:
    runs-on: self-hosted  # Self-hosted Runner에서 실행

    steps:
      # 1. GitHub 리포지토리 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Docker 로그인 및 이미지 빌드/푸시
      - name: Build and Push Docker Image to Harbor
        env:
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}  # Harbor 비밀번호를 환경변수로 설정
        run: |
          docker login -u admin -p "$HARBOR_PASSWORD" 192.168.2.184
          IMAGE_TAG=192.168.2.184/momo/citest:${{ github.run_number }}
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

