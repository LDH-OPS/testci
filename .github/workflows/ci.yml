name: Build and Push Docker Image to Harbor

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰

jobs:
  build-and-push:
    runs-on: self-hosted  # Self-hosted Runnerì—ì„œ ì‹¤í–‰

    steps:
      # 1. GitHub ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. íƒœê·¸ ìë™ ì¦ê°€ (1.0, 1.1, 1.2 ...)
      - name: Generate Incremental Tag
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          NEW_TAG="1.$RUN_NUMBER"
          echo "New Tag: $NEW_TAG"
          echo "IMAGE_TAG=192.168.2.184/momo/front:$NEW_TAG" >> $GITHUB_ENV

      # 3. Docker ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ (admin ê³„ì • ì‚¬ìš©)
      - name: Build and Push Docker Image to Harbor
        env:
          HARBOR_USERNAME: "admin"  # ê´€ë¦¬ì ê³„ì • ì§ì ‘ ì‚¬ìš©
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          docker login -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD" 192.168.2.184
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

  vulnerability-scan:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      # 1. Trivy ì„¤ì¹˜ (sudo -S ì˜µì…˜ ì‚¬ìš©í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ ìë™ ì…ë ¥)
      - name: Install Trivy
        env:
          RUNNER_PASSWORD: ${{ secrets.RUNNER_PASSWORD }}  # GitHub Secretsì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        run: |
          echo "$RUNNER_PASSWORD" | sudo -S apt-get update
          echo "$RUNNER_PASSWORD" | sudo -S apt-get install -y wget jq
          
          # Trivy ìµœì‹  ë²„ì „ ìë™ ë‹¤ìš´ë¡œë“œ
          TRIVY_LATEST_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | jq -r .tag_name)
          wget https://github.com/aquasecurity/trivy/releases/download/$TRIVY_LATEST_VERSION/trivy_$(echo $TRIVY_LATEST_VERSION | sed 's/v//')_Linux-64bit.tar.gz
          
          tar -xvzf trivy_*.tar.gz
          echo "$RUNNER_PASSWORD" | sudo -S mv trivy /usr/local/bin/

      # 2. Trivy ì·¨ì•½ì  ê²€ì‚¬ ì‹¤í–‰
      - name: Run Trivy Scan
        run: |
          trivy image --format json --output trivy-report.json $IMAGE_TAG
          cat trivy-report.json

      # 3. ì·¨ì•½ì  ê²€ì‚¬ ê²°ê³¼ Slack ì•Œë¦¼ ì „ì†¡
      - name: Send Report to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "HIGH")] | length' trivy-report.json)
          CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "CRITICAL")] | length' trivy-report.json)

          MESSAGE="{
            \"attachments\": [
              {
                \"color\": \"#ff0000\",
                \"title\": \"ğŸ” Harbor Image Security Scan Report\",
                \"fields\": [
                  {\"title\": \"ğŸ›‘ Critical\", \"value\": \"$CRITICAL_COUNT\", \"short\": true},
                  {\"title\": \"âš ï¸ High\", \"value\": \"$HIGH_COUNT\", \"short\": true}
                ],
                \"footer\": \"Security Bot\",
                \"ts\": $(date +%s)
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL

