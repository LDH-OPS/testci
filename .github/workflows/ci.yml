name: Build and Push Docker Image to Harbor

on:
  push:
    branches:
      - main  # main Î∏åÎûúÏπòÏóê Ìë∏ÏãúÎê† Îïå Ïã§Ìñâ

jobs:
  build-and-push:
    runs-on: self-hosted  # Self-hosted RunnerÏóêÏÑú Ïã§Ìñâ

    steps:
      # 1. GitHub Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ Ï≤¥ÌÅ¨ÏïÑÏõÉ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. ÌÉúÍ∑∏ ÏûêÎèô Ï¶ùÍ∞Ä (1.0, 1.1, 1.2 ...)
      - name: Generate Incremental Tag
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: |
          NEW_TAG="1.$RUN_NUMBER"
          echo "New Tag: $NEW_TAG"
          echo "IMAGE_TAG=192.168.2.184/momo/front:$NEW_TAG" >> $GITHUB_ENV

      # 3. Docker Î°úÍ∑∏Ïù∏ Î∞è Ïù¥ÎØ∏ÏßÄ ÎπåÎìú/Ìë∏Ïãú
      - name: Build and Push Docker Image to Harbor
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          docker login -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD" 192.168.2.184
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

  vulnerability-scan:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      # 1. ÏµúÏã† Trivy Î≤ÑÏ†Ñ ÏÑ§Ïπò (sudo Î¨∏Ï†ú Ìï¥Í≤∞)
      - name: Install Trivy
        run: |
          apt-get update && apt-get install -y wget jq
          
          # Trivy ÏµúÏã† Î≤ÑÏ†Ñ ÏûêÎèô Îã§Ïö¥Î°úÎìú
          TRIVY_LATEST_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | jq -r .tag_name)
          wget https://github.com/aquasecurity/trivy/releases/download/$TRIVY_LATEST_VERSION/trivy_$(echo $TRIVY_LATEST_VERSION | sed 's/v//')_Linux-64bit.tar.gz
          
          tar -xvzf trivy_*.tar.gz
          mv trivy /usr/local/bin/

      # 2. Trivy Ï∑®ÏïΩÏ†ê Í≤ÄÏÇ¨ Ïã§Ìñâ
      - name: Run Trivy Scan
        run: |
          trivy image --format json --output trivy-report.json $IMAGE_TAG
          cat trivy-report.json

      # 3. Ï∑®ÏïΩÏ†ê Í≤ÄÏÇ¨ Í≤∞Í≥º Slack ÏïåÎ¶º Ï†ÑÏÜ°
      - name: Send Report to Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          HIGH_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "HIGH")] | length' trivy-report.json)
          CRITICAL_COUNT=$(jq '[.Results[].Vulnerabilities[] | select(.Severity == "CRITICAL")] | length' trivy-report.json)

          MESSAGE="{
            \"attachments\": [
              {
                \"color\": \"#ff0000\",
                \"title\": \"üîç Harbor Image Security Scan Report\",
                \"fields\": [
                  {\"title\": \"üõë Critical\", \"value\": \"$CRITICAL_COUNT\", \"short\": true},
                  {\"title\": \"‚ö†Ô∏è High\", \"value\": \"$HIGH_COUNT\", \"short\": true}
                ],
                \"footer\": \"Security Bot\",
                \"ts\": $(date +%s)
              }
            ]
          }"

          curl -X POST -H 'Content-type: application/json' --data "$MESSAGE" $SLACK_WEBHOOK_URL

